<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Barcode Scanner App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
      text-align: center;
    }
    h1 { margin-bottom: 15px; }
    button {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      margin: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #interactive {
      width: 100%;
      max-width: 480px;
      margin: 20px auto;
      border-radius: 12px;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
    }
    th { background: #efefef; }
    #priceModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.5);
    }
    #modalContent {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 320px;
    }
    #priceInput {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 18px;
      border-radius: 6px;
      border: 1px solid #ccc;
      inputmode: decimal;
    }
  </style>
</head>
<body>
  <h1>Barcode Scanner App</h1>
  <div>
    <button id="startButton">Start Scanning</button>
    <button id="newOrderBtn">Start New Order</button>
    <button id="exportCSV">Export CSV</button>
  </div>

  <div id="interactive" class="viewport"></div>

  <table id="dataTable">
    <thead>
      <tr><th>Barcode</th><th>Price</th><th>Time</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="priceModal">
    <div id="modalContent">
      <h3>Enter Price</h3>
      <input id="priceInput" type="number" placeholder="Enter price" inputmode="decimal" />
      <div style="margin-top:15px;">
        <button id="savePriceBtn">Save</button>
        <button id="cancelBtn" style="background:#dc3545;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let scanning = false;
    let currentOrder = JSON.parse(localStorage.getItem('currentOrder')) || [];
    let allOrders = JSON.parse(localStorage.getItem('allOrders')) || [];
    let priceMemory = JSON.parse(localStorage.getItem('priceMemory')) || {}; // remember barcode-price pairs
    let lastScannedCode = null;

    const startButton = document.getElementById('startButton');
    const newOrderBtn = document.getElementById('newOrderBtn');
    const exportCSV = document.getElementById('exportCSV');
    const dataTable = document.querySelector('#dataTable tbody');
    const priceModal = document.getElementById('priceModal');
    const priceInput = document.getElementById('priceInput');
    const savePriceBtn = document.getElementById('savePriceBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    function startScanner() {
      if (scanning) return;
      scanning = true;
      startButton.textContent = 'Stop Scanning';

      Quagga.init({
        inputStream: {
          name: 'Live',
          type: 'LiveStream',
          target: document.querySelector('#interactive'),
          constraints: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        },
        decoder: { readers: ['ean_reader', 'ean_8_reader'] },
        locate: true,
        locator: { patchSize: 'medium', halfSample: false }
      }, err => {
        if (err) { console.error(err); return; }
        Quagga.start();
      });

      Quagga.onDetected(result => {
        const code = result.codeResult.code;
        stopScanner();
        lastScannedCode = code;
        showPriceModal(code);
      });
    }

    function stopScanner() {
      if (!scanning) return;
      scanning = false;
      startButton.textContent = 'Start Scanning';
      Quagga.stop();
    }

    function showPriceModal(code) {
      priceModal.style.display = 'flex';
      priceInput.value = priceMemory[code] || '';
      priceInput.focus();
    }

    savePriceBtn.onclick = function() {
      const price = parseFloat(priceInput.value);
      if (isNaN(price)) { alert('Please enter a valid price.'); return; }

      const now = new Date().toLocaleString();
      const item = { barcode: lastScannedCode, price, time: now };
      currentOrder.push(item);
      priceMemory[lastScannedCode] = price;
      saveData();
      renderTable();

      priceModal.style.display = 'none';
      priceInput.value = '';

      // Auto resume scanning
      startScanner();
    };

    cancelBtn.onclick = function() {
      priceModal.style.display = 'none';
      lastScannedCode = null;
      // Stay stopped if cancelled
    };

    function saveData() {
      localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
      localStorage.setItem('allOrders', JSON.stringify(allOrders));
      localStorage.setItem('priceMemory', JSON.stringify(priceMemory));
    }

    function renderTable() {
      dataTable.innerHTML = '';
      currentOrder.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.barcode}</td><td>${item.price}</td><td>${item.time}</td><td><button onclick="deleteRow(${index})" style="background:#dc3545;">Delete</button></td>`;
        dataTable.appendChild(tr);
      });
    }

    function deleteRow(index) {
      currentOrder.splice(index, 1);
      saveData();
      renderTable();
    }

    startButton.onclick = () => {
      if (scanning) stopScanner(); else startScanner();
    };

    newOrderBtn.onclick = () => {
      if (currentOrder.length === 0) return alert('No items in current order.');
      const total = currentOrder.reduce((sum, i) => sum + i.price, 0);
      alert(`Order total: â‚¹${total.toFixed(2)}`);
      allOrders.push({ items: currentOrder, total, time: new Date().toLocaleString() });
      currentOrder = [];
      saveData();
      renderTable();
    };

    exportCSV.onclick = () => {
      let csv = 'Order,Barcode,Price,Time\n';
      allOrders.forEach((order, i) => {
        order.items.forEach(item => {
          csv += `${i+1},${item.barcode},${item.price},${item.time}\n`;
        });
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'barcode_data.csv';
      a.click();
    };

    renderTable();
  </script>
</body>
</html>
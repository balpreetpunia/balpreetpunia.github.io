<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Barcode POS Web App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0 10px;
    }

    h1 {
      text-align: center;
      margin: 20px 0;
    }

    #scanner-container {
      position: relative;
      max-width: 500px;
      margin: 0 auto;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      touch-action: manipulation;
    }

    video, canvas {
      width: 100%;
      border-radius: 10px;
    }

    /* Focus indicator */
    #focus-indicator {
      position: absolute;
      border: 2px solid #00FF00;
      width: 60px;
      height: 60px;
      border-radius: 8px;
      pointer-events: none;
      display: none;
      transform: translate(-50%, -50%);
    }

    .controls {
      display: flex;
      justify-content: center;
      margin: 10px 0;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    input[type="text"], input[type="number"], input[type="range"] {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f2f2f2;
    }

    #order-total {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }

    @media (max-width: 500px) {
      button {
        flex: 1 1 100%;
      }
      .controls {
        flex-direction: column;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
  <h1>Barcode POS</h1>

  <div id="scanner-container">
    <div id="focus-indicator"></div>
  </div>

  <div class="controls">
    <button id="toggle-scan">Start Scanning</button>
    <input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1">
  </div>

  <div class="controls">
    <input type="text" id="manual-barcode" placeholder="Enter barcode manually">
    <button id="add-manual">Add Manually</button>
  </div>

  <table id="items-table">
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Price</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="order-total">Order Total: ₹0</div>

  <div class="controls">
    <button id="new-order">Start New Order</button>
    <button id="export-csv">Export CSV</button>
  </div>

  <script>
    let scanning = false;
    let currentOrder = [];
    let barcodePrices = JSON.parse(localStorage.getItem('barcodePrices') || '{}');
    let allOrders = JSON.parse(localStorage.getItem('allOrders') || '[]');

    const itemsTableBody = document.querySelector('#items-table tbody');
    const orderTotalElem = document.getElementById('order-total');
    const focusIndicator = document.getElementById('focus-indicator');
    const scannerContainer = document.getElementById('scanner-container');

    function saveData() {
      localStorage.setItem('barcodePrices', JSON.stringify(barcodePrices));
      localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
      localStorage.setItem('allOrders', JSON.stringify(allOrders));
    }

    function updateTable() {
      itemsTableBody.innerHTML = '';
      let total = 0;
      currentOrder.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${item.barcode}</td><td>₹${item.price}</td><td>${item.timestamp}</td>`;
        itemsTableBody.appendChild(row);
        total += parseFloat(item.price);
      });
      orderTotalElem.textContent = `Order Total: ₹${total.toFixed(2)}`;
      saveData();
    }

    function promptPrice(barcode) {
      let price = barcodePrices[barcode] || '';
      price = prompt(`Enter price for barcode: ${barcode}`, price);
      if(price !== null && price !== '') {
        barcodePrices[barcode] = price;
        const timestamp = new Date().toLocaleString();
        currentOrder.push({ barcode, price, timestamp });
        updateTable();
      }
    }

    function startScanner() {
      Quagga.init({
        inputStream : {
          name : "Live",
          type : "LiveStream",
          target: scannerContainer,
          constraints: {
            facingMode: "environment",
            width: { min: 640 },
            height: { min: 480 },
            zoom: 1
          }
        },
        decoder: {
          readers: ["ean_reader", "ean_8_reader"]
        }
      }, function(err) {
          if (err) { console.log(err); return; }
          Quagga.start();
          scanning = true;
          document.getElementById('toggle-scan').textContent = 'Stop Scanning';
      });

      Quagga.onDetected(data => {
        Quagga.pause();
        promptPrice(data.codeResult.code);
        Quagga.start();
      });
    }

    function stopScanner() {
      Quagga.stop();
      scanning = false;
      document.getElementById('toggle-scan').textContent = 'Start Scanning';
    }

    document.getElementById('toggle-scan').addEventListener('click', () => {
      if(scanning) stopScanner();
      else startScanner();
    });

    document.getElementById('add-manual').addEventListener('click', () => {
      const barcode = document.getElementById('manual-barcode').value.trim();
      if(barcode) {
        promptPrice(barcode);
        document.getElementById('manual-barcode').value = '';
      }
    });

    document.getElementById('new-order').addEventListener('click', () => {
      if(currentOrder.length === 0) {
        alert('No items in current order!');
        return;
      }
      const total = currentOrder.reduce((sum, item) => sum + parseFloat(item.price), 0);
      alert(`Order Total: ₹${total.toFixed(2)}`);
      allOrders.push([...currentOrder]);
      currentOrder = [];
      updateTable();
      saveData();
    });

    document.getElementById('export-csv').addEventListener('click', () => {
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Barcode,Price,Timestamp,OrderIndex\n";
      allOrders.forEach((order, index) => {
        order.forEach(item => {
          csvContent += `${item.barcode},${item.price},${item.timestamp},${index+1}\n`;
        });
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "orders.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    document.getElementById('zoom-slider').addEventListener('input', (e) => {
      const track = Quagga.cameraAccess.getActiveTrack();
      if(track && track.getCapabilities().zoom) {
        track.applyConstraints({advanced: [{zoom: parseFloat(e.target.value)}]});
      }
    });

    // Tap-to-focus
    scannerContainer.addEventListener('click', async (e) => {
      const track = Quagga.cameraAccess.getActiveTrack();
      if(!track) return;

      const capabilities = track.getCapabilities();
      if(!capabilities.focusMode || !capabilities.focusMode.includes('single-shot')) return;

      const rect = scannerContainer.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;

      focusIndicator.style.left = `${e.clientX - rect.left}px`;
      focusIndicator.style.top = `${e.clientY - rect.top}px`;
      focusIndicator.style.display = 'block';
      setTimeout(() => { focusIndicator.style.display = 'none'; }, 500);

      try {
        await track.applyConstraints({
          advanced: [{ focusMode: 'single-shot', pointsOfInterest: [{ x, y }] }]
        });
      } catch(err) {
        console.log('Focus not supported:', err);
      }
    });

    // Load previous data
    currentOrder = JSON.parse(localStorage.getItem('currentOrder') || '[]');
    updateTable();
  </script>
</body>
</html>
